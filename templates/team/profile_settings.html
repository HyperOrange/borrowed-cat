{% extends 'base.html' %}
{% load static %}

{% block title %}프로필 설정{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            overflow-y: auto;
        }

        .profile-container {
            padding: 20px 20px 50px 20px;
            max-width: 420px;
            margin: 0 auto;
            box-sizing: border-box;
            background-color: #f8f9fa;
        }

        .page-header {
            margin-bottom: 40px;
            padding-top: 20px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            text-align: left;
            margin: 0;
        }

        /* 고양이 프로필 선택 영역 */
        .cat-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            padding: 10px 0;
        }

        .arrow-btn {
            background: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .arrow-btn i {
            color: white;
            font-size: 16px;
        }

        .arrow-btn:hover {
            background: #555;
        }

        .cat-profile-wrapper {
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .cat-profile {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* 닉네임 입력 영역 */
        .input-section {
            margin-bottom: 40px;
        }

        .input-label {
            display: block;
            font-size: 16px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .text-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            box-sizing: border-box;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #f4c043;
            box-shadow: 0 0 0 3px rgba(244, 192, 67, 0.1);
        }

        .text-input::placeholder {
            color: #adb5bd;
        }

        /* 태그 선택 영역 */
        .tag-section {
            margin-bottom: 20px;
        }

        .tag-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            text-align: left;
        }

        .tag-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .tag-button {
            background-color: white;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 15px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .tag-button:hover {
            border-color: #f4c043;
            background-color: #fef8e8;
        }

        .tag-button.selected {
            background: linear-gradient(135deg, #f4c043 0%, #f1b02a 100%);
            border-color: #f4c043;
            color: white;
            font-weight: 600;
        }

        /* 확인 버튼 */
        .start-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #f4c043 0%, #f1b02a 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 10px 0 30px 0;
            box-shadow: 0 4px 15px rgba(244, 192, 67, 0.3);
        }

        .start-button:hover {
            background: linear-gradient(135deg, #f1b02a 0%, #e6a020 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 192, 67, 0.4);
        }

        .start-button:active {
            transform: translateY(0);
        }

        /* 반응형 */
        @media (max-width: 480px) {
            .profile-container {
                padding: 15px;
            }
            
            .cat-selector {
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .cat-profile-wrapper {
                width: 160px;
                height: 160px;
            }
            
            .cat-profile {
                width: 160px;
                height: 160px;
                border-radius: 12px;
            }
            
            .arrow-btn {
                width: 35px;
                height: 35px;
            }
            
            .arrow-btn i {
                font-size: 14px;
            }

            .tag-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="profile-container">
        <div class="page-header">
            <h1 class="page-title">
                {% if is_edit %}
                    프로필 수정
                {% else %}
                    프로필 설정
                {% endif %}
            </h1>
        </div>

        <form action="{% if is_edit %}{% url 'team:edit_member' team_id=team_id member_id=member.id %}{% else %}{% url 'team:add_member' team_id=team_id %}{% endif %}" method="post" id="profile-form">
            {% csrf_token %}
            
            <!-- 고양이 이미지 선택 -->
            <div class="cat-selector">
                <button type="button" class="arrow-btn" id="prev-cat">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="cat-profile-wrapper">
                    <img id="cat-image" src="{% static 'img/cat_1.jpg' %}" alt="프로필 고양이 이미지" class="cat-profile">
                </div>
                <button type="button" class="arrow-btn" id="next-cat">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <input type="hidden" name="profile_image" id="profile-image-input" value="cat_1.jpg">
            </div>

            <!-- 닉네임 입력 -->
            <div class="input-section">
                <label for="nickname" class="input-label">닉네임</label>
                <input type="text" id="nickname" name="nickname" class="text-input" placeholder="두 글자 이상 입력해주세요" required minlength="2" {% if is_edit %}value="{{ member.nickname }}"{% endif %}>
            </div>

            <!-- 수식어 버튼 선택 -->
            <div class="tag-section">
                <h2 class="tag-title">당신을 가장 잘 나타내는 키워드는?</h2>
                <div class="tag-grid">
                    <button type="button" class="tag-button">책임감</button>
                    <button type="button" class="tag-button">준비성</button>
                    <button type="button" class="tag-button">부지런함</button>
                    <button type="button" class="tag-button">꼼꼼함</button>
                    <button type="button" class="tag-button">긍정적 마인드</button>
                    <button type="button" class="tag-button">실행력</button>
                    <button type="button" class="tag-button">열정</button>
                    <button type="button" class="tag-button">논리적 사고</button>
                    <button type="button" class="tag-button">소통</button>
                    <button type="button" class="tag-button">끈기</button>
                    <button type="button" class="tag-button">발표력</button>
                    <button type="button" class="tag-button">예술감각</button>
                    <button type="button" class="tag-button">창의적</button>
                    <button type="button" class="tag-button">리더십</button>
                    <button type="button" class="tag-button">쾌활한</button>
                    <button type="button" class="tag-button">회의적인</button>
                </div>
                <input type="hidden" name="tags" id="tags-input">
            </div>

            <button type="submit" class="start-button">
                {% if is_edit %}
                    수정완료
                {% else %}
                    확인
                {% endif %}
            </button>
        </form>
    </div>

    <script>
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                const catImages = ['cat_1.jpg', 'cat_2.jpg', 'cat_3.jpg', 'cat_4.jpg', 'cat_5.jpg'];
                let currentCatIndex = 0;
                const catImageElement = document.getElementById('cat-image');
                const profileImageInput = document.getElementById('profile-image-input');
                
                // 수정 모드일 때 기존 데이터 로드
                {% if is_edit %}
                    // 기존 프로필 이미지 설정
                    const existingImage = '{{ member.profile_image }}';
                    currentCatIndex = catImages.indexOf(existingImage);
                    if (currentCatIndex === -1) currentCatIndex = 0;
                    catImageElement.src = "{% static 'img/' %}" + catImages[currentCatIndex];
                    profileImageInput.value = catImages[currentCatIndex];
                    
                    // 기존 태그 선택 상태 설정
                    const existingTags = '{{ member.tags }}'.split(',').map(tag => tag.trim()).filter(tag => tag);
                    var selectedTags = new Set(existingTags);
                {% else %}
                    var selectedTags = new Set();
                {% endif %}
                
                // 고양이 이미지 변경 함수
                function changeCat(direction) {
                    currentCatIndex = (currentCatIndex + direction + catImages.length) % catImages.length;
                    const newImage = catImages[currentCatIndex];
                    catImageElement.src = "{% static 'img/' %}" + newImage;
                    profileImageInput.value = newImage;
                }

                document.getElementById('prev-cat').addEventListener('click', () => changeCat(-1));
                document.getElementById('next-cat').addEventListener('click', () => changeCat(1));

                const tagButtons = document.querySelectorAll('.tag-button');
                const tagsInput = document.getElementById('tags-input');
                
                // 수정 모드일 때 기존 선택된 태그 표시
                {% if is_edit %}
                    tagButtons.forEach(button => {
                        const tag = button.textContent.trim();
                        if (selectedTags.has(tag)) {
                            button.classList.add('selected');
                        }
                    });
                    tagsInput.value = Array.from(selectedTags).join(',');
                {% endif %}
                
                // 태그 선택/해제 로직
                tagButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        this.classList.toggle('selected');
                        const tag = this.textContent.trim();
                        if (this.classList.contains('selected')) {
                            selectedTags.add(tag);
                        } else {
                            selectedTags.delete(tag);
                        }
                        tagsInput.value = Array.from(selectedTags).join(',');
                        console.log('선택된 태그:', tagsInput.value);
                    });
                });

                // 폼 검증
                document.getElementById('profile-form').addEventListener('submit', function(e) {
                    const nickname = document.getElementById('nickname').value;
                    if (nickname.length < 2) {
                        e.preventDefault();
                        alert('닉네임을 두 글자 이상 입력해주세요.');
                    } else if (selectedTags.size === 0) {
                        e.preventDefault();
                        alert('수식어를 하나 이상 선택해주세요.');
                    }
                });
            });
        })();
    </script>
{% endblock %}