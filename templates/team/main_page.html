{% extends 'base.html' %}
{% load static %}

{% block title %}팀플 관리{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="main-container">
        <header class="main-header">
            <div class="team-info">
                <span class="team-name">{{ team.team_name }}</span>
            </div>
            <div class="header-actions">
                <div class="d-day-badge">
                    <span id="d-day-text">D-Day</span>
                </div>
                <button class="share-button-bg" id="share-link-button">
                    <i class="fas fa-link"></i>
                </button>
            </div>
        </header>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
            <span class="progress-text" id="progress-text">0%</span>
        </div>

        <div class="member-list-container">
            {% for member in team.members.all %}
            <a href="{% url 'team:edit_member' team_id=team.team_id member_id=member.id %}" class="member-item member-link">
                <div class="member-profile">
                    <img src="{% static 'img/' %}{{ member.profile_image }}" alt="{{ member.nickname }}" class="member-cat-img">
                </div>
                <div class="member-role-box">
                    <span class="member-role-text">{{ member.nickname }}</span>
                    {% if member.tags %}
                        <p class="member-tags">{{ member.tags }}</p>
                    {% endif %}
                </div>
            </a>
            {% empty %}
                <p class="no-members-text">팀원이 아직 없습니다. 아래 버튼을 눌러 팀원을 추가하세요.</p>
            {% endfor %}
            
            <a href="{% url 'team:add_member' team_id=team.team_id %}" 
            class="member-item add-member" style="text-decoration: none !important;">
                <div class="member-profile add-button-circle">
                    <i class="fas fa-plus add-icon"></i>
                </div>
                <div class="member-role-box add-member-text">
                    <span class="member-role-text">팀원으로 참가하기</span>
                </div>
            </a>
        </div>

        <div class="button-grid-new">
            <a href="{% url 'role_distribution:role_page' team_id=team.team_id %}" class="grid-button">역할 정하기</a>
            <button class="grid-button">To-Do list</button>
            <button class="grid-button">링크 모음</button>
        </div>
        <div class="start-new-team-button-container">
            <a href="{% url 'core:index' %}" class="start-new-team-button">새 팀플 시작하기</a>
        </div>
    </div>

    <style>
        .member-link {
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s ease;
        }
        
        .member-link:hover {
            transform: translateY(-2px);
        }

        .button-grid-new {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .grid-button {
            background-color: #fff;
            color: #333;
            border: 2px solid #f1b02a;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .grid-button:hover {
            background-color: #f1b02a;
            color: #fff;
        }

        .start-new-team-button-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .start-new-team-button {
            width: 100%;
            background-color: #f1b02a;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 15px 0;
            border-radius: 25px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .d-day-badge {
            background-color: #f1b02a;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const shareButton = document.getElementById('share-link-button');
        if (shareButton) {
            shareButton.addEventListener('click', function() {
                const urlToCopy = window.location.href;
                
                navigator.clipboard.writeText(urlToCopy).then(function() {
                    alert('팀플 링크가 복사되었습니다!');
                }).catch(function(err) {
                    console.error('클립보드 복사 실패:', err);
                    alert('클립보드 복사에 실패했습니다. 직접 URL을 복사해주세요.');
                });
            });
        }

        // D-Day 및 진행도 계산 및 표시
        const deadlineDateStr = '{{ team.deadline_date|date:"Y-m-d" }}';
        const deadlineTimeStr = '{{ team.deadline_time|time:"H:i" }}';
        
        const dDayTextEl = document.getElementById('d-day-text');
        const progressBarEl = document.getElementById('progress-bar');
        const progressTextEl = document.getElementById('progress-text');
        
        if (deadlineDateStr) {
            const deadline = new Date(`${deadlineDateStr}T${deadlineTimeStr}`);
            const today = new Date();
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff === 0) {
                dDayTextEl.textContent = 'D-Day';
            } else if (daysDiff > 0) {
                dDayTextEl.textContent = `D-${daysDiff}`;
            } else {
                dDayTextEl.textContent = `D+${Math.abs(daysDiff)}`;
            }
            
            // 진행도 계산 (단, 시작일이 있어야 함)
            // 현재 시작일 데이터가 없으므로 마감일만으로 간단하게 처리
            // 실제 서비스에서는 팀 생성 시 시작일도 함께 저장해야 정확합니다.
            const totalDays = 100; // 임의의 전체 기간 설정
            const elapsedDays = totalDays - daysDiff;
            const progress = Math.max(0, Math.min(100, (elapsedDays / totalDays) * 100));

            progressBarEl.style.width = `${progress}%`;
            progressTextEl.textContent = `${Math.round(progress)}%`;

        } else {
            dDayTextEl.textContent = '마감일 미설정';
            progressBarEl.style.width = '0%';
            progressTextEl.textContent = '0%';
        }
    });
</script>
{% endblock %}