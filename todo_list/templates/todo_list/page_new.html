{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- 폰트 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

    <!-- Anima CSS -->
    <link rel="stylesheet" href="{% static 'todo_list/css/globals.css' %}" />
    <link rel="stylesheet" href="{% static 'todo_list/css/styleguide.css' %}" />
    <link rel="stylesheet" href="{% static 'todo_list/css/style.css' %}" />

    <style>
      .app {
        max-width: 414px; margin: 0 auto; min-height: 100dvh;
        padding: max(12px, env(safe-area-inset-top)) 16px max(12px, env(safe-area-inset-bottom));
        background: #fff; font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      }
      img{max-width:100%; height:auto;}
      .frame { display:flex; align-items:center; gap:8px; padding:8px 0; }
      .frame .text-wrapper-3 { font-weight:700; font-size:20px; }
      .icon-chevron-left { display:inline-flex; width:24px; height:24px; }
      /* 플로팅 느낌의 카드/레이어는 그대로 두되, 입력 요소만 실제 폼으로 바꿔서 submit 되게 */
      .floating-card{ position:relative; border-radius:16px; overflow:hidden; }
      .btn-primary{ display:inline-flex; align-items:center; justify-content:center;
        border-radius:12px; padding:12px 16px; background:#222; color:#fff; font-weight:600; }
      .input, .select, .textarea{
        width:100%; box-sizing:border-box; padding:12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff;
        font-size:15px;
      }
      .field{ display:grid; gap:8px; margin:12px 0; }
    </style>
  </head>
  <body>
    <main class="app">

      <!-- 상단 헤더 (system-bar 제거) -->
      <div class="frame">
        <a class="icon-chevron-left" href="{% url 'todo:list' team_token=team_token %}" aria-label="뒤로가기">
          <img class="vector" src="{% static 'todo_list/img/vector.svg' %}" alt="back" />
        </a>
        <div class="text-wrapper-3">할 일 추가</div>
      </div>

      <div class="indicator"><div class="line"></div></div>

      <!-- 배경/장식 요소: 필요하면 유지 -->
      <img class="rectangle-11" src="{% static 'todo_list/img/rectangle-249.svg' %}" alt="" />

      <!-- ✅ 실제 동작하는 입력 폼 -->
      <form id="todo-add-form" class="floating-card" style="padding:16px; background:#fff;">
        {% csrf_token %}

        <div class="field">
          <label for="title" class="text-wrapper-15">할 일을 입력해주세요</label>
          <input id="title" name="title" class="input" type="text" placeholder="예) 발표자료 목차 잡기" required />
        </div>

        <div class="field">
          <label for="due_date" class="text-wrapper-16">마감기한을 정해주세요</label>
          <input id="due_date" name="due_date" class="input" type="date" />
        </div>

        <div class="field">
          <label for="assignee_id" class="text-wrapper-17">담당자를 정해주세요</label>
          <select id="assignee_id" name="assignee_id" class="select">
            <option value="">선택 안 함</option>
            {% for m in members %}<option value="{{ m.id }}">{{ m.nickname }}</option>{% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="priority" class="text-wrapper-18">우선순위</label>
          <select id="priority" name="priority" class="select">
            <option value="M">중</option>
            <option value="H">상</option>
            <option value="L">하</option>
          </select>
        </div>

        <div class="field">
          <label for="description" class="text-wrapper-18">메모를 적어주세요</label>
          <textarea id="description" name="description" class="textarea" rows="4" placeholder="설명(선택)"></textarea>
        </div>

        <!-- (디자인 요소를 살릴 이미지/장식은 유지 가능) -->
        <!-- <img class="rectangle-12" src="{% static 'todo_list/img/rectangle-4194.svg' %}" alt="" /> 등등 -->

        <div style="display:flex; gap:8px; margin-top:16px;">
          <button type="submit" class="btn-primary">추가하기</button>
          <a href="{% url 'todo:list' team_token=team_token %}" class="btn-primary" style="background:#F3F4F6; color:#111;">
            취소
          </a>
        </div>
      </form>

      <!-- 기존 플로팅 플러스 버튼/문구는 다른 페이지에서 사용 -->
    </main>

    <!-- AJAX: 성공 시 목록으로 돌아가기 -->
    <script>
      function getCookie(name){let v=null;if(document.cookie){for(const c of document.cookie.split(';')){const s=c.trim();if(s.startsWith(name+'=')){v=decodeURIComponent(s.slice(name.length+1));break;}}}return v;}
      const CSRF = getCookie("csrftoken");
      const addURL = "{% url 'todo:add' team_token=team_token %}";
      const backToList = "{% url 'todo:list' team_token=team_token %}";

      document.getElementById("todo-add-form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const res = await fetch(addURL, { method:"POST", headers:{ "X-CSRFToken": CSRF }, body: fd });
        if(!res.ok){ return alert(await res.text()); }
        const data = await res.json();
        if(data.ok){ window.location.href = backToList; }
      });
    </script>
  </body>
</html>
